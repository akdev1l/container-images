name: build customized container images

on:
  schedule:
    - cron: '30 4 * * 6'
  push:
    paths-ignore: '**.md'
    branches: [ "master" ]

jobs:
  build-base:
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Log in to ghcr.io
      uses: redhat-actions/podman-login@v1
      with:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        registry: ghcr.io/${{ github.repository }}

    - name: Build ${{ github.repository_owner }}/${{ github.event.repository.name }}/base
      run: ./build.sh base

  build-cli-tools:
    needs: build-base
    strategy:
      matrix:
        image:
          - awscdk
          - dotfiles
          - ghcli
          - iotop
          - jekyll
          - pandoc
          - ripgrep
          - watch_gha_runs
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Log in to ghcr.io
      uses: redhat-actions/podman-login@v1
      with:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        registry: ghcr.io/${{ github.repository }}

    - name: publish all container images
      run: ./build.sh ${{ matrix.image }}
